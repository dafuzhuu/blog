<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/blog/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=blog/livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>基于JoinQuant的因子回测框架 | Blog</title>
<meta name="keywords" content="因子">
<meta name="description" content="from jqfactor import get_factor_values, neutralize, winsorize_med, standardlize from jqfactor import Factor, calc_factors import datetime import pandas as pd import numpy as np import matplotlib.pyplot as plt import statsmodels.api as sm from scipy.stats import spearmanr,pearsonr import matplotlib.pyplot as plt import matplotlib.dates as mdates import copy import time plt.rcParams[&#39;font.sans-serif&#39;] = [&#39;SimHei&#39;] # 用来正常显示中文标签 plt.rcParams[&#39;axes.unicode_minus&#39;] = False # 用来正常显示负号 获取数据 获取交易日 输入：start_date（起始日期），end_date（终止日期），freq（频率），count（None）
# 1.1-获取交易日 def get_calendar(start_date=None, end_date=None, freq=&#39;D&#39;, count=None): &#34;&#34;&#34; params: start_date(Timestamp)：起始日期，年月日 end_date(Timestamp)：终止日期，年月日 freq(str)：交易日频率，默认每天 - &#39;W&#39;: 每周 - &#39;M&#39;: 每月 - &#39;Q&#39;: 每季度 - &#39;Y&#39;: 每年 count(int)：获取终止日期前交易日数量 return: df.">
<meta name="author" content="Dafu">
<link rel="canonical" href="http://localhost:1313/blog/posts/factor_framework/">
<link crossorigin="anonymous" href="/blog/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css" integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/blog/assets/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/blog/assets/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/blog/assets/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/blog/assets/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/blog/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/blog/posts/factor_framework/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script src="//cdn.jsdelivr.net/npm/@xiee/utils/js/math-code.min.js" defer></script>

<script defer
  src="//mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>


  

<meta property="og:title" content="基于JoinQuant的因子回测框架" />
<meta property="og:description" content="from jqfactor import get_factor_values, neutralize, winsorize_med, standardlize from jqfactor import Factor, calc_factors import datetime import pandas as pd import numpy as np import matplotlib.pyplot as plt import statsmodels.api as sm from scipy.stats import spearmanr,pearsonr import matplotlib.pyplot as plt import matplotlib.dates as mdates import copy import time plt.rcParams[&#39;font.sans-serif&#39;] = [&#39;SimHei&#39;] # 用来正常显示中文标签 plt.rcParams[&#39;axes.unicode_minus&#39;] = False # 用来正常显示负号 获取数据 获取交易日 输入：start_date（起始日期），end_date（终止日期），freq（频率），count（None）
# 1.1-获取交易日 def get_calendar(start_date=None, end_date=None, freq=&#39;D&#39;, count=None): &#34;&#34;&#34; params: start_date(Timestamp)：起始日期，年月日 end_date(Timestamp)：终止日期，年月日 freq(str)：交易日频率，默认每天 - &#39;W&#39;: 每周 - &#39;M&#39;: 每月 - &#39;Q&#39;: 每季度 - &#39;Y&#39;: 每年 count(int)：获取终止日期前交易日数量 return: df." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/blog/posts/factor_framework/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-08-25T12:07:27+08:00" />
<meta property="article:modified_time" content="2024-08-25T12:07:27+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="基于JoinQuant的因子回测框架"/>
<meta name="twitter:description" content="from jqfactor import get_factor_values, neutralize, winsorize_med, standardlize from jqfactor import Factor, calc_factors import datetime import pandas as pd import numpy as np import matplotlib.pyplot as plt import statsmodels.api as sm from scipy.stats import spearmanr,pearsonr import matplotlib.pyplot as plt import matplotlib.dates as mdates import copy import time plt.rcParams[&#39;font.sans-serif&#39;] = [&#39;SimHei&#39;] # 用来正常显示中文标签 plt.rcParams[&#39;axes.unicode_minus&#39;] = False # 用来正常显示负号 获取数据 获取交易日 输入：start_date（起始日期），end_date（终止日期），freq（频率），count（None）
# 1.1-获取交易日 def get_calendar(start_date=None, end_date=None, freq=&#39;D&#39;, count=None): &#34;&#34;&#34; params: start_date(Timestamp)：起始日期，年月日 end_date(Timestamp)：终止日期，年月日 freq(str)：交易日频率，默认每天 - &#39;W&#39;: 每周 - &#39;M&#39;: 每月 - &#39;Q&#39;: 每季度 - &#39;Y&#39;: 每年 count(int)：获取终止日期前交易日数量 return: df."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/blog/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "基于JoinQuant的因子回测框架",
      "item": "http://localhost:1313/blog/posts/factor_framework/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "基于JoinQuant的因子回测框架",
  "name": "基于JoinQuant的因子回测框架",
  "description": "from jqfactor import get_factor_values, neutralize, winsorize_med, standardlize from jqfactor import Factor, calc_factors import datetime import pandas as pd import numpy as np import matplotlib.pyplot as plt import statsmodels.api as sm from scipy.stats import spearmanr,pearsonr import matplotlib.pyplot as plt import matplotlib.dates as mdates import copy import time plt.rcParams[\u0026#39;font.sans-serif\u0026#39;] = [\u0026#39;SimHei\u0026#39;] # 用来正常显示中文标签 plt.rcParams[\u0026#39;axes.unicode_minus\u0026#39;] = False # 用来正常显示负号 获取数据 获取交易日 输入：start_date（起始日期），end_date（终止日期），freq（频率），count（None）\n# 1.1-获取交易日 def get_calendar(start_date=None, end_date=None, freq=\u0026#39;D\u0026#39;, count=None): \u0026#34;\u0026#34;\u0026#34; params: start_date(Timestamp)：起始日期，年月日 end_date(Timestamp)：终止日期，年月日 freq(str)：交易日频率，默认每天 - \u0026#39;W\u0026#39;: 每周 - \u0026#39;M\u0026#39;: 每月 - \u0026#39;Q\u0026#39;: 每季度 - \u0026#39;Y\u0026#39;: 每年 count(int)：获取终止日期前交易日数量 return: df.",
  "keywords": [
    "因子"
  ],
  "articleBody": "from jqfactor import get_factor_values, neutralize, winsorize_med, standardlize from jqfactor import Factor, calc_factors import datetime import pandas as pd import numpy as np import matplotlib.pyplot as plt import statsmodels.api as sm from scipy.stats import spearmanr,pearsonr import matplotlib.pyplot as plt import matplotlib.dates as mdates import copy import time plt.rcParams['font.sans-serif'] = ['SimHei'] # 用来正常显示中文标签 plt.rcParams['axes.unicode_minus'] = False # 用来正常显示负号 获取数据 获取交易日 输入：start_date（起始日期），end_date（终止日期），freq（频率），count（None）\n# 1.1-获取交易日 def get_calendar(start_date=None, end_date=None, freq='D', count=None): \"\"\" params: start_date(Timestamp)：起始日期，年月日 end_date(Timestamp)：终止日期，年月日 freq(str)：交易日频率，默认每天 - 'W': 每周 - 'M': 每月 - 'Q': 每季度 - 'Y': 每年 count(int)：获取终止日期前交易日数量 return: df.index(DatetimeIndex)：交易日索引列表 \"\"\" # 调整时间格式 start = pd.to_datetime(start_date) end = pd.to_datetime(end_date) # 时间区间 if count != None: df = get_price('000001.XSHG', end_date=end, count=count) else: df = get_price('000001.XSHG', start_date=start, end_date=end) # 时间周期 end_day = df.index df[freq] = df.index.to_period(freq).start_time end_day = df.groupby(freq).apply(lambda x: x.index.max()) return pd.to_datetime(end_day.values) # 例子 start = \"20230101\" end = \"20231231\" get_calendar(start, end, freq='M') 输出\nDatetimeIndex(['2023-01-31', '2023-02-28', '2023-03-31', '2023-04-28', '2023-05-31', '2023-06-30', '2023-07-31', '2023-08-31', '2023-09-28', '2023-10-31', '2023-11-30', '2023-12-29'], dtype='datetime64[ns]', freq=None) 筛选股票函数 剔除\nST股 次新股 开盘涨跌停股（可选） # 1.2-筛选股票函数 def filter_stock(stock_list, date, days=21*3, limit=1): \"\"\" params: stock_list (list)：股票序列列表，[\"600000.XSHG\", ...] date (Timestamp)：交易日，年月日 days (int)：过滤次新股时间 limit (int)：过滤涨跌停开关，1/0 return: stock_list (list)：过滤后的股票序列列表，[\"600000.XSHG\", ...] \"\"\" date = pd.to_datetime(date) # 除上市距beginDate不足3个月的股票 def _delete_new(stocks, begin_date, n=days): filtered_list = [] for stock in stocks: start_date = get_security_info(stock).start_date if start_date \u003c (begin_date - pd.Timedelta(days=n)).date(): filtered_list.append(stock) return filtered_list # 剔除ST股 st_data = get_extras('is_st', stock_list, count=1, end_date=date) stock_list = [stock for stock in stock_list if not st_data[stock][0]] # 剔除次新股 stock_list = _delete_new(stock_list, date, n=days) # 剔除开盘涨停股票 if limit == 1: df = get_price(stock_list, end_date=date, fields=['open', 'high_limit', 'low_limit'], count=1, skip_paused=True, panel=False) df = df.set_index(\"code\") df['h_limit'] = (df['open'] != df['high_limit']) df['l_limit'] = (df['open'] != df['low_limit']) # 过滤开盘涨跌停股票 stock_list = [i for i in df.index if (df.loc[i, \"h_limit\"] and df.loc[i, \"l_limit\"])] return stock_list # 例子 stockList = list(map(normalize_code, [\"301136\", \"000586\", \"300125\"])) # 301136为2022-01-11上市 print(\"剔除次新股：\", filter_stock(stockList, \"20220102\")) # 300125在2024-06-10为ST股 print(\"剔除ST股：\", filter_stock(stockList, \"20240610\")) # 000586在2024-08-07开盘涨停 print(\"剔除开盘涨跌停股：\", filter_stock(stockList, \"20240807\")) 输出\n剔除次新股： ['000586.XSHE', '300125.XSHE'] 剔除ST股： ['301136.XSHE', '000586.XSHE'] 剔除开盘涨跌停股： ['301136.XSHE'] 获取因子值函数 joinquant中有两类因子：因子库、定义因子\n文档：\n因子库 定义因子 其中因子库为joinquant内置，输入字符串即可获取。定义因子是继承Factor类后自己定义的因子，本质上是一个子类。\n# 1.3-获取因子值函数，必须全部为聚宽因子或全部为定义因子 # 可以分别获取后再合并 def get_factor_df(stock_list, factor_list, date): \"\"\" params: stock_list(list)：股票序列列表，[\"600000.XSHG\",...] factor_list(list)：因子名称列表，[\"residual_volatility\",...] date(Timestamp)：交易日，年月日（取前一日的因子值） return: df(DataFrame)：因子数据集，pd.DataFrame(index=[stock_list], columns=[factor_list]) \"\"\" date = pd.to_datetime(date) # 取前一天的数据 last_date = get_near_trade_day(date, -1) if type(factor_list[0]) == str: factor_data = get_factor_values(securities=stock_list, factors=factor_list, end_date=last_date, count=1) # 如果是定义因子像ep()这种，需要因子计算 else: factor_data = calc_factors(securities=stock_list, factors=factor_list, start_date=last_date, end_date=last_date, use_real_price=False, skip_paused=True) factor_list = [factor.name for factor in factor_list] df = pd.concat([pd.DataFrame(factor_data[f]).T for f in factor_list], axis=1) df.columns = factor_list return df # 例子 stock_list = list(map(normalize_code, [\"301136\", \"000586\", \"300125\"])) factor_list = [\"beta\", \"size\", \"momentum\"] get_factor_df(stock_list, factor_list, \"20240701\") 输出\ncode beta size momentum 301136.XSHE 2.435321 -2.257106 -1.057598 000586.XSHE 2.069847 -2.969061 -1.214831 300125.XSHE 2.515297 -4.036516 -3.761750 获取每期股票对应的因子值和收益率 输入日期，因子，以及股票池；对每天的因子值进行去极值（winsorize）、行业市值中性化（neutralize）、标准化（standardlize），至此因子预处理完成。\n接着考虑下期收益率。不存在滞后算子时（lag=0）\n$$ R_t=\\frac{P_{t+1}}{P_t} $$\n若引入滞后算子$i\\neq 0$，则\n$$ R_t^i=\\frac{P_{t+1+i}}{P_t} $$\n所以如果时间序列为 $t_1,t_2,t_3,t_4,t_5$，则lag=0时收益率数据只有四个$R_1,R_2,R_3,R_4$，lag=1时只有三个$R_1^1,R_2^1,R_3^1$，以此类推。\n(len(date_list) - 1) - i - 1 \u003c lag_i 左式为结束日期到当前日期的距离，右式为收益率跨度\n验证：当lag_i = 0时，到最后一个时间点，即 i=(len(date_list)-1)-1，此时0\u003c0=False，存在即期收益率，正确。\n# 1.4-获取每期股票对应的因子值和收益率 def get_fac_ret_dict(date_list, factor_list, index_code=None, lag_num=5): \"\"\" params: date_list (list)：交易日列表 factor_list (list)：因子名称列表，如 [\"residual_volatility\", ...] index_code (str)：指数代码，表示股票池，None 表示全市场池 lag_num (int)：收益率延期期数，方便后续计算因子 IC 半衰期 return: dict：因子数据集的时间字典，格式为 {date: pd.DataFrame(index=[stock_list], columns=[factor_list + yield])} \"\"\" data_dict = {} lag_num_list = list(range(lag_num + 1)) # 删掉最后一期（需要下期收益率） for i in range(len(date_list) - 1): day = date_list[i] # 选择股票池 pool = get_index_stocks(index_code, day) if index_code else get_all_securities(date=day).index # 过滤股票 pool = filter_stock(pool, day) # 获取因子数据 df = get_factor_df(pool, factor_list, day).dropna(axis=0, how='any') pool = df.index.tolist() # 异常值处理：中位数法 df = winsorize_med(df, scale=3, inclusive=True, inf2nan=True, axis=0) # 行业市值中性化 df = neutralize(df, how=['sw_l1', 'market_cap'], date=day, axis=0) # 标准化 df = standardlize(df, inf2nan=True, axis=0) # 获取当天价格 price = get_price(pool, count=1, end_date=day, skip_paused=True, panel=False, fields=['close'])['close'] # 计算延期收益率（每个lag单独算） for lag_i in lag_num_list: # 剩余天数不足lag，用0填充 if (len(date_list) - 1) - i \u003c lag_i + 1: df[lag_i] = np.zeros(len(pool)) else: next_day = date_list[i + 1 + lag_i] next_price = get_price(pool, count=1, end_date=next_day, skip_paused=True, panel=False, fields=['close'])['close'] df[lag_i] = next_price.values / price.values - 1 data_dict[day] = df return data_dict # 例子 date_list = get_calendar(end=\"20240807\", count=60, freq='W') factor_list = [\"beta\", \"size\", \"momentum\"] index_code = '000300.XSHG' fac_ret_dict = get_fac_ret_dict(date_list, factor_list, index_code) date = date_list[5] print(f\"{date} 因子值和收益率\") fac_ret_dict[date].head() 输出\n2024-06-21 00:00:00 因子值和收益率\ncode beta size momentum 0 1 2 3 4 5 000001.XSHE 0.716460 0.569768 -0.579750 0.015000 -0.003000 0.031000 0.037000 0.003000 0.014000 000002.XSHE 0.640406 0.438910 -0.987371 -0.036161 -0.043115 -0.033380 -0.018081 -0.048679 -0.052851 000063.XSHE 1.509532 1.183595 -0.655145 0.000366 -0.016850 0.023443 0.029670 -0.013553 -0.025275 000100.XSHE -0.755233 0.651778 0.740881 0.018868 -0.004717 0.009434 -0.061321 -0.087264 -0.091981 000157.XSHE -0.559411 -0.672491 0.715088 -0.026596 -0.063830 -0.057181 -0.074468 -0.102394 -0.125000 因子有效性测试 IC测试 IC衡量预测变量的预测能力，其定义通常为$t+1$时刻的预测收益率与真实收益率在截面上的相关系数。\n实操中，$t+1$时刻的预测收益率常用$t$时刻的预测变量代替（也就是因子值）\n# 2.1 因子IC测试 def factor_IC_test(_fac_ret_dict, _factor_list): date_list = list(_fac_ret_dict.keys()) IC_df = pd.DataFrame(0, index=date_list, columns=_factor_list) IC_stats_df = pd.DataFrame(0, index=[\"IC_mean\", \"IC_std\", \"IR\", \"sig_prop\", \"t-value\"], columns=_factor_list) for date in date_list: for factor in _factor_list: fac_ret_df = _fac_ret_dict[date][[factor, 0]] ic, p_value = spearmanr(fac_ret_df.loc[:, factor], fac_ret_df.loc[:, 0]) IC_df.loc[date, factor] = ic IC_stats_df.loc[\"IC_mean\"] = IC_df.mean(axis=0) IC_stats_df.loc[\"IC_std\"] = IC_df.std(axis=0) IC_stats_df.loc[\"IR\"] = IC_df.mean(axis=0) / IC_df.std(axis=0) IC_stats_df.loc[\"sig_prop\"] = np.sum(np.abs(IC_df) \u003e 0.02, axis=0) / np.count_nonzero(IC_df, axis=0) IC_stats_df.loc[\"t-value\"] = IC_df.mean(axis=0) / IC_df.std(axis=0) * np.sqrt(len(IC_df)) return IC_df, IC_stats_df # 例子 IC_df, IC_stats_df = factor_IC_test(fac_ret_dict, factor_list) IC_df.head() 输出\nDate beta size momentum 2024-05-17 -0.208500 0.056870 0.114491 2024-05-24 -0.106488 -0.011449 -0.013559 2024-05-31 -0.274823 0.185290 0.313269 2024-06-07 0.136722 -0.059606 -0.052470 2024-06-14 -0.184472 0.152148 0.299300 IC_stats_df 输出\nbeta size momentum IC_mean -0.058974 0.022510 0.025554 IC_std 0.141956 0.095083 0.184682 IR -0.415435 0.236741 0.138367 sig_prop 1.000000 0.833333 0.916667 t-value -1.439109 0.820095 0.479318 因子分组并计算组合收益率 需要IC测试判断因子和收益率相关性的正负，再分组并构建投资组合\n# 2.2-因子分组并计算投资组合收益率 def get_group_portfolio_dict(_data_dict, _factor_list, neg_corr_fac_list, group_num=5, weight_method=\"avg\", index_code=\"000300.XSHG\"): \"\"\" params: _data_dict(dict)：因子值数据集的时间字典，{date：pd.DataFrame(index=[stock_list], columns=[_factor_list + yield(0)])} _factor_list(list)：因子名称列表，[\"residual_volatility\",...] neg_corr_fac_list(list)：与收益率为负相关的因子名称列表 group_num(int)：因子分组的组数，其中第0组为不分组 weight_method(str)：投资组合股票权重类型 index_code(str): 基准指数 return: group_factor_dict(dict): 分组因子值数据集的时间字典，{date：pd.DataFrame(columns=[group_num])} group_yield_dict(dict): 分组股票收益率数据集的时间字典，{date：pd.DataFrame(columns=[group_num])} portfolio_yield_dict(dict): 分组投资组合收益率的时间字典， {date：pd.DataFrame(index=[date], columns=[0 + group_num + index + long_short])} \"\"\" date_list = list(_data_dict.keys()) # 初始化字典：分组后的因子暴露和股票收益率 group_factor_dict = dict.fromkeys(_factor_list) group_yield_dict = dict.fromkeys(_factor_list) for factor in _factor_list: # 每个value是新的字典 {date: None} group_factor_dict[factor] = dict([(k, None) for k in date_list]) group_yield_dict[factor] = dict([(k, None) for k in date_list]) # 初始化字典：投资组合的收益率 group_list = list(range(group_num + 1)) # 0代表不分组 portfolio_yield_dict = {} for factor in _factor_list: portfolio_yield_dict[factor] = pd.DataFrame(data=None, index=date_list, columns=group_list) # 遍历每个时间点的因子值\u0026资产收益率 for date, data in _data_dict.items(): # 遍历每个因子 for factor in _factor_list: # 如果因子与收益负相关 is_ascending = factor in neg_corr_fac_list # 若IC\u003c0, 则升序排列；若IC\u003e0, 则降序排列（收益率理应更高的股票排在前面） all_stock = data.sort_values(factor, ascending=is_ascending).index lens = len(all_stock) # 无法被组数整除的部分用nan填充 nan_num = np.full(group_num - lens % group_num, np.nan) # 股票分组，不足的补全nan值（用reshape分组） all_stock_filled = np.append(all_stock, nan_num) group_stock = all_stock_filled.reshape((group_num, -1)).T # 股票收益率分组 yield_ = data.loc[list(all_stock), 0].values yield_filled = np.append(yield_, nan_num) group_yield = yield_filled.reshape((group_num, -1)).T # 股票因子值分组 factor_ = data.loc[list(all_stock), factor].values factor_filled = np.append(factor_, nan_num) group_factor = factor_filled.reshape((group_num, -1)).T # 分组后股票对应因子和对应收益率 group_factor_dict[factor][date] = pd.DataFrame(data=group_factor, columns=group_list[1:]) group_yield_dict[factor][date] = pd.DataFrame(data=group_yield, columns=group_list[1:]) if weight_method == \"mktcap\": # 分组后市值加权投资组合收益率 size_ = get_factor_values(securities=list(all_stock), factors=[\"market_cap\"], end_date=date, count=1)[\"market_cap\"] size0 = size0.applymap(lambda x: x ** -0.333).values # 照顾小市值 size_filled = np.append(size_, nan_num) size_grouped = size_filled.reshape((group_num, -1)).T # 将市值分组，得到每组市值 # 不分组，整体的收益 portfolio = np.nansum(yield_ * (size_ / np.nansum(size_))) # 分组，每组的收益（组内的股票共用一个权重） portfolio_group = np.nansum(group_yield * (size_grouped / np.nansum(size_grouped, axis=0)), axis=0) # columns=[0, 1, 2, ..., n], with n groups portfolio_yield_dict[factor].loc[date, :] = np.append(portfolio, portfolio_group) else: # 分组后等权投资组合收益率 portfolio = np.nanmean(yield_) portfolio_group = np.nanmean(group_yield, axis=0) portfolio_yield_dict[factor].loc[date, :] = np.append(portfolio, portfolio_group) # 将未分组、指数、多空组合统计进入投资组合中 # date_list(_data_dict的键)删减了最后一个交易日，计算收益率需要补回来 end_date = get_near_trade_day(date_list[-1], 1) index_price = get_price(index_code, start_date=date_list[0], end_date=end_date, skip_paused=True, panel=False, fields=['open']) date_list.append(end_date) index_price = index_price.loc[date_list, \"open\"] for factor in _factor_list: portfolio_yield_dict[factor][\"index\"] = (index_price / index_price.shift(1)).dropna(axis=0, how='any').values - 1 # 第一组 - 最后一组 portfolio_yield_dict[factor][\"long_short\"] = portfolio_yield_dict[factor][1] - portfolio_yield_dict[factor][group_num] return group_factor_dict, group_yield_dict, portfolio_yield_dict # 例子 data_dict = fac_ret_dict.copy() factor_list = factor_list.copy() neg_corr_fac_list = [\"beta\"] group_factor_dict, group_yield_dict, portfolio_yield_dict = get_group_portfolio_dict(data_dict, factor_list, neg_corr_fac_list) print(f\"group_factor_dict: beta, {date_list[5]}\") group_factor_dict[\"beta\"][date_list[5]].head(10) # row as stocks(not the same in each row!), column as groups 输出\ngroup_factor_dict: beta, 2024-06-21 00:00:00\n1 2 3 4 5 0 -3.127815 -0.782981 -0.220503 0.241513 0.899368 1 -2.608957 -0.777437 -0.217409 0.263952 0.905673 2 -2.466028 -0.771171 -0.213984 0.270753 0.906024 3 -2.379335 -0.770582 -0.209276 0.295320 0.926811 4 -2.236061 -0.755233 -0.204300 0.318216 0.939260 5 -2.146409 -0.753317 -0.200050 0.318709 0.942325 6 -2.138083 -0.748938 -0.196521 0.328538 0.945144 7 -1.982549 -0.728641 -0.196068 0.352257 0.968289 8 -1.951236 -0.672973 -0.195188 0.358029 0.974325 9 -1.912529 -0.669878 -0.190616 0.370640 0.985332 print(f\"group_yield_dict: beta, {date_list[5]}\") group_yield_dict[\"beta\"][date_list[5]].head(10) 输出\ngroup_yield_dict: beta, 2024-06-21 00:00:00\n1 2 3 4 5 0 0.015873 -0.054359 0.015328 0.005828 -0.004678 1 -0.029513 0.015817 -0.017335 0.054304 -0.030735 2 -0.038543 -0.097788 0.025758 0.003311 -0.072949 3 -0.059705 -0.009297 -0.072324 0.011792 -0.039123 4 0.056701 0.018868 -0.053505 -0.033629 -0.011364 5 -0.004926 -0.024651 -0.072303 0.013011 -0.063488 6 0.060438 0.042201 0.040793 0.053456 0.007519 7 -0.020833 -0.081037 -0.095761 -0.035380 -0.101844 8 -0.010228 0.048269 -0.039514 -0.073384 -0.038304 9 -0.063094 0.000000 0.013255 -0.039593 -0.027425 print(f\"portfolio_yield_dict: beta\") portfolio_yield_dict[\"beta\"] 输出\nDate 0 1 2 3 4 5 index long_short 2024-05-17 -0.0212019 -0.0212385 -0.0172659 -0.0110899 -0.024375 -0.0330077 -0.002124 0.0117692 2024-05-24 -0.0026993 -0.00157968 5.88723e-05 0.00493396 -0.014688 -0.00217902 -0.008541 0.00059934 2024-05-31 -0.00422427 0.0113847 -0.00175829 0.000561831 -0.0162851 -0.0159888 -0.001442 0.0273735 2024-06-07 -0.00109651 -0.00648105 -0.00998194 6.14662e-05 7.22157e-05 0.0119131 -0.022208 -0.0183942 2024-06-14 -0.0165621 -0.00675819 -0.016695 -0.0076833 -0.0241726 -0.0284781 -0.005252 0.0217199 2024-06-21 -0.0169605 -0.012736 -0.010357 -0.0100194 -0.0143996 -0.0391058 -0.015064 0.0263698 2024-06-28 -0.0133534 -0.0159938 -0.00656651 -0.00745181 -0.0158852 -0.0215409 -0.000090 0.00554702 2024-07-05 0.0163921 0.0105308 0.0197113 0.00671937 0.0250903 0.0202228 0.004821 -0.00969201 2024-07-12 0.0231685 0.0313948 0.0179932 0.015852 0.0219193 0.0291754 0.011806 0.00221932 2024-07-19 -0.0316384 -0.0362365 -0.0269216 -0.0324149 -0.0317956 -0.0307507 -0.027736 -0.00548579 2024-07-26 -0.000504842 -0.00238374 -0.0017709 -0.00674665 -0.00465131 0.0142367 -0.002876 -0.0166205 2024-08-02 -0.00884012 -0.00919352 -0.0124423 -0.00690704 -0.00256224 -0.0134754 -0.009373 0.0042819 plot_return(portfolio_yield_dict[\"beta\"]) 工具函数 def get_near_trade_day(date, count): \"\"\" 获取相邻的交易日。 参数: date (Timestamp)：当天交易日，年月日。 count (int)：交易日相隔数，负数代表前，正数代表后。 返回: Timestamp：上一个或下一个交易日，年月日。 \"\"\" # 获取上一个交易日 if count \u003c 0: df = get_price('000001.XSHG', end_date=date, count=abs(count) + 1) return df.index[0] # 获取下一个交易日 elif count \u003e 0: df = get_price('000001.XSHG', start_date=date, end_date=datetime.date.today()) return df.index[count] # 如果 count == 0，返回原日期 return date def plot_return(df): \"\"\" 绘制收益率曲线图 params: df(dataframe): 每日收益率数据，pd.DataFrame(index=[dates], columns=[portfolios]) \"\"\" num_ticks = 12 plt.figure(figsize=(18,6)) cum_return = (1 + df).cumprod() - 1 for col in df.columns: plt.plot(df.index, cum_return[col] * 100, label=col) dates = pd.to_datetime(df.index, unit=\"ms\") ticks = np.linspace(0, len(dates) - 1, num_ticks, dtype=int) plt.xticks(dates[ticks]) plt.gca().xaxis.set_major_formatter(mdates.DateFormatter('%Y-%m-%d')) plt.gcf().autofmt_xdate() plt.legend() plt.show() # 计时器 def count_time(func, *args, number): start_time = time.time() for _ in range(number): func(*args) end_time = time.time() return end_time - start_time 不足之处 借用了JoinQuant平台的内置函数，只能在平台上运行，对内存、算力等有限制，自由度太低 目前只实现了基本的因子测试部分（IC，long-short），更多功能有 测试部分加上FSC，t统计量指标 缺少Fama-MacBeth等回归（结合石川因子投资） 缺少组合优化和选股 Python运行速度很慢 下阶段将重点研究\n更多因子投资方法 将以上框架用DolphinDB实现 将新的因子投资方法用DolphinDB实现 预计10月前完成。因子框架完成后在筹码分布上测试，连接到筹码这部分只需把计算筹码数据和筹码因子的函数换成DolphinDB语言，工作量不大，同期可以记录些筹码因子的idea\n参考文献 因子研究框架—收益模型篇 自定义python库 《因子投资 - 方法与实践》 API文档 因子库 因子分析（定义因子） ",
  "wordCount" : "1580",
  "inLanguage": "en",
  "datePublished": "2024-08-25T12:07:27+08:00",
  "dateModified": "2024-08-25T12:07:27+08:00",
  "author":{
    "@type": "Person",
    "name": "Dafu"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/blog/posts/factor_framework/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/blog/assets/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/blog/" accesskey="h" title="Blog (Alt + H)">Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/blog/archives/" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/blog/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/blog/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/blog/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/blog/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      基于JoinQuant的因子回测框架
    </h1>
    <div class="post-meta"><span title='2024-08-25 12:07:27 +0800 CST'>August 25, 2024</span>&nbsp;·&nbsp;8 min&nbsp;·&nbsp;Dafu&nbsp;|&nbsp;<a href="https://github.com/dafuzhuu/blog/tree/main/content/posts/factor_framework/index.md" rel="noopener noreferrer" target="_blank">Edit</a>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e8%8e%b7%e5%8f%96%e6%95%b0%e6%8d%ae" aria-label="获取数据">获取数据</a><ul>
                        
                <li>
                    <a href="#%e8%8e%b7%e5%8f%96%e4%ba%a4%e6%98%93%e6%97%a5" aria-label="获取交易日">获取交易日</a></li>
                <li>
                    <a href="#%e7%ad%9b%e9%80%89%e8%82%a1%e7%a5%a8%e5%87%bd%e6%95%b0" aria-label="筛选股票函数">筛选股票函数</a></li>
                <li>
                    <a href="#%e8%8e%b7%e5%8f%96%e5%9b%a0%e5%ad%90%e5%80%bc%e5%87%bd%e6%95%b0" aria-label="获取因子值函数">获取因子值函数</a></li>
                <li>
                    <a href="#%e8%8e%b7%e5%8f%96%e6%af%8f%e6%9c%9f%e8%82%a1%e7%a5%a8%e5%af%b9%e5%ba%94%e7%9a%84%e5%9b%a0%e5%ad%90%e5%80%bc%e5%92%8c%e6%94%b6%e7%9b%8a%e7%8e%87" aria-label="获取每期股票对应的因子值和收益率">获取每期股票对应的因子值和收益率</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%9b%a0%e5%ad%90%e6%9c%89%e6%95%88%e6%80%a7%e6%b5%8b%e8%af%95" aria-label="因子有效性测试">因子有效性测试</a><ul>
                        
                <li>
                    <a href="#ic%e6%b5%8b%e8%af%95" aria-label="IC测试">IC测试</a></li>
                <li>
                    <a href="#%e5%9b%a0%e5%ad%90%e5%88%86%e7%bb%84%e5%b9%b6%e8%ae%a1%e7%ae%97%e7%bb%84%e5%90%88%e6%94%b6%e7%9b%8a%e7%8e%87" aria-label="因子分组并计算组合收益率">因子分组并计算组合收益率</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%b7%a5%e5%85%b7%e5%87%bd%e6%95%b0" aria-label="工具函数">工具函数</a></li>
                <li>
                    <a href="#%e4%b8%8d%e8%b6%b3%e4%b9%8b%e5%a4%84" aria-label="不足之处">不足之处</a></li>
                <li>
                    <a href="#%e5%8f%82%e8%80%83%e6%96%87%e7%8c%ae" aria-label="参考文献">参考文献</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">jqfactor</span> <span class="kn">import</span> <span class="n">get_factor_values</span><span class="p">,</span> <span class="n">neutralize</span><span class="p">,</span> <span class="n">winsorize_med</span><span class="p">,</span> <span class="n">standardlize</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">jqfactor</span> <span class="kn">import</span> <span class="n">Factor</span><span class="p">,</span> <span class="n">calc_factors</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">datetime</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">spearmanr</span><span class="p">,</span><span class="n">pearsonr</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.dates</span> <span class="k">as</span> <span class="nn">mdates</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">copy</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.sans-serif&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SimHei&#39;</span><span class="p">]</span> <span class="c1"># 用来正常显示中文标签</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.unicode_minus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># 用来正常显示负号</span>
</span></span></code></pre></div><h1 id="获取数据">获取数据<a hidden class="anchor" aria-hidden="true" href="#获取数据">#</a></h1>
<h2 id="获取交易日">获取交易日<a hidden class="anchor" aria-hidden="true" href="#获取交易日">#</a></h2>
<p>输入：start_date（起始日期），end_date（终止日期），freq（频率），count（None）</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 1.1-获取交易日</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_calendar</span><span class="p">(</span><span class="n">start_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    params:
</span></span></span><span class="line"><span class="cl"><span class="s2">    start_date(Timestamp)：起始日期，年月日
</span></span></span><span class="line"><span class="cl"><span class="s2">    end_date(Timestamp)：终止日期，年月日
</span></span></span><span class="line"><span class="cl"><span class="s2">    freq(str)：交易日频率，默认每天
</span></span></span><span class="line"><span class="cl"><span class="s2">     - &#39;W&#39;: 每周
</span></span></span><span class="line"><span class="cl"><span class="s2">     - &#39;M&#39;: 每月
</span></span></span><span class="line"><span class="cl"><span class="s2">     - &#39;Q&#39;: 每季度
</span></span></span><span class="line"><span class="cl"><span class="s2">     - &#39;Y&#39;: 每年
</span></span></span><span class="line"><span class="cl"><span class="s2">    count(int)：获取终止日期前交易日数量
</span></span></span><span class="line"><span class="cl"><span class="s2">    
</span></span></span><span class="line"><span class="cl"><span class="s2">    return:
</span></span></span><span class="line"><span class="cl"><span class="s2">    df.index(DatetimeIndex)：交易日索引列表
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 调整时间格式</span>
</span></span><span class="line"><span class="cl">    <span class="n">start</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">start_date</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">end</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">end_date</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 时间区间</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">count</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">df</span> <span class="o">=</span> <span class="n">get_price</span><span class="p">(</span><span class="s1">&#39;000001.XSHG&#39;</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">df</span> <span class="o">=</span> <span class="n">get_price</span><span class="p">(</span><span class="s1">&#39;000001.XSHG&#39;</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 时间周期</span>
</span></span><span class="line"><span class="cl">    <span class="n">end_day</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span><span class="o">.</span><span class="n">start_time</span>
</span></span><span class="line"><span class="cl">    <span class="n">end_day</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">end_day</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 例子</span>
</span></span><span class="line"><span class="cl"><span class="n">start</span> <span class="o">=</span> <span class="s2">&#34;20230101&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">end</span> <span class="o">=</span> <span class="s2">&#34;20231231&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">get_calendar</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>输出</p>
<pre tabindex="0"><code>DatetimeIndex([&#39;2023-01-31&#39;, &#39;2023-02-28&#39;, &#39;2023-03-31&#39;, &#39;2023-04-28&#39;,
               &#39;2023-05-31&#39;, &#39;2023-06-30&#39;, &#39;2023-07-31&#39;, &#39;2023-08-31&#39;,
               &#39;2023-09-28&#39;, &#39;2023-10-31&#39;, &#39;2023-11-30&#39;, &#39;2023-12-29&#39;],
              dtype=&#39;datetime64[ns]&#39;, freq=None)
</code></pre><h2 id="筛选股票函数">筛选股票函数<a hidden class="anchor" aria-hidden="true" href="#筛选股票函数">#</a></h2>
<p>剔除</p>
<ul>
<li>ST股</li>
<li>次新股</li>
<li>开盘涨跌停股（可选）</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 1.2-筛选股票函数</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">filter_stock</span><span class="p">(</span><span class="n">stock_list</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="mi">21</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    params:
</span></span></span><span class="line"><span class="cl"><span class="s2">    stock_list (list)：股票序列列表，[&#34;600000.XSHG&#34;, ...]
</span></span></span><span class="line"><span class="cl"><span class="s2">    date (Timestamp)：交易日，年月日
</span></span></span><span class="line"><span class="cl"><span class="s2">    days (int)：过滤次新股时间
</span></span></span><span class="line"><span class="cl"><span class="s2">    limit (int)：过滤涨跌停开关，1/0
</span></span></span><span class="line"><span class="cl"><span class="s2">    
</span></span></span><span class="line"><span class="cl"><span class="s2">    return:
</span></span></span><span class="line"><span class="cl"><span class="s2">    stock_list (list)：过滤后的股票序列列表，[&#34;600000.XSHG&#34;, ...]
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 除上市距beginDate不足3个月的股票</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_delete_new</span><span class="p">(</span><span class="n">stocks</span><span class="p">,</span> <span class="n">begin_date</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">days</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">filtered_list</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">stock</span> <span class="ow">in</span> <span class="n">stocks</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">start_date</span> <span class="o">=</span> <span class="n">get_security_info</span><span class="p">(</span><span class="n">stock</span><span class="p">)</span><span class="o">.</span><span class="n">start_date</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">start_date</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">begin_date</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">n</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="n">filtered_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">filtered_list</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 剔除ST股</span>
</span></span><span class="line"><span class="cl">    <span class="n">st_data</span> <span class="o">=</span> <span class="n">get_extras</span><span class="p">(</span><span class="s1">&#39;is_st&#39;</span><span class="p">,</span> <span class="n">stock_list</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">date</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">stock_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">stock</span> <span class="k">for</span> <span class="n">stock</span> <span class="ow">in</span> <span class="n">stock_list</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">st_data</span><span class="p">[</span><span class="n">stock</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 剔除次新股</span>
</span></span><span class="line"><span class="cl">    <span class="n">stock_list</span> <span class="o">=</span> <span class="n">_delete_new</span><span class="p">(</span><span class="n">stock_list</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">days</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 剔除开盘涨停股票</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">limit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">df</span> <span class="o">=</span> <span class="n">get_price</span><span class="p">(</span><span class="n">stock_list</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">date</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;high_limit&#39;</span><span class="p">,</span> <span class="s1">&#39;low_limit&#39;</span><span class="p">],</span> 
</span></span><span class="line"><span class="cl">                       <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skip_paused</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">panel</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&#34;code&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;h_limit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;high_limit&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;l_limit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low_limit&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 过滤开盘涨跌停股票</span>
</span></span><span class="line"><span class="cl">        <span class="n">stock_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&#34;h_limit&#34;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&#34;l_limit&#34;</span><span class="p">])]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">stock_list</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 例子</span>
</span></span><span class="line"><span class="cl"><span class="n">stockList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">normalize_code</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;301136&#34;</span><span class="p">,</span> <span class="s2">&#34;000586&#34;</span><span class="p">,</span> <span class="s2">&#34;300125&#34;</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 301136为2022-01-11上市</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;剔除次新股：&#34;</span><span class="p">,</span> <span class="n">filter_stock</span><span class="p">(</span><span class="n">stockList</span><span class="p">,</span> <span class="s2">&#34;20220102&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 300125在2024-06-10为ST股</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;剔除ST股：&#34;</span><span class="p">,</span> <span class="n">filter_stock</span><span class="p">(</span><span class="n">stockList</span><span class="p">,</span> <span class="s2">&#34;20240610&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 000586在2024-08-07开盘涨停</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;剔除开盘涨跌停股：&#34;</span><span class="p">,</span> <span class="n">filter_stock</span><span class="p">(</span><span class="n">stockList</span><span class="p">,</span> <span class="s2">&#34;20240807&#34;</span><span class="p">))</span>
</span></span></code></pre></div><p>输出</p>
<pre tabindex="0"><code>剔除次新股： [&#39;000586.XSHE&#39;, &#39;300125.XSHE&#39;]
剔除ST股： [&#39;301136.XSHE&#39;, &#39;000586.XSHE&#39;]
剔除开盘涨跌停股： [&#39;301136.XSHE&#39;]
</code></pre><h2 id="获取因子值函数">获取因子值函数<a hidden class="anchor" aria-hidden="true" href="#获取因子值函数">#</a></h2>
<p>joinquant中有两类因子：因子库、定义因子</p>
<p>文档：</p>
<ul>
<li><a href="https://www.joinquant.com/help/api/help#name:factor_values">因子库</a></li>
<li><a href="https://www.joinquant.com/help/api/help#factor:%E5%9B%A0%E5%AD%90%E5%88%86%E6%9E%90API">定义因子</a></li>
</ul>
<p>其中因子库为joinquant内置，输入字符串即可获取。定义因子是继承Factor类后自己定义的因子，本质上是一个子类。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 1.3-获取因子值函数，必须全部为聚宽因子或全部为定义因子</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 可以分别获取后再合并</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_factor_df</span><span class="p">(</span><span class="n">stock_list</span><span class="p">,</span> <span class="n">factor_list</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    params:
</span></span></span><span class="line"><span class="cl"><span class="s2">    stock_list(list)：股票序列列表，[&#34;600000.XSHG&#34;,...]
</span></span></span><span class="line"><span class="cl"><span class="s2">    factor_list(list)：因子名称列表，[&#34;residual_volatility&#34;,...]
</span></span></span><span class="line"><span class="cl"><span class="s2">    date(Timestamp)：交易日，年月日（取前一日的因子值）
</span></span></span><span class="line"><span class="cl"><span class="s2">    
</span></span></span><span class="line"><span class="cl"><span class="s2">    return:
</span></span></span><span class="line"><span class="cl"><span class="s2">    df(DataFrame)：因子数据集，pd.DataFrame(index=[stock_list], columns=[factor_list])
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 取前一天的数据</span>
</span></span><span class="line"><span class="cl">    <span class="n">last_date</span> <span class="o">=</span> <span class="n">get_near_trade_day</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">factor_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">factor_data</span> <span class="o">=</span> <span class="n">get_factor_values</span><span class="p">(</span><span class="n">securities</span><span class="o">=</span><span class="n">stock_list</span><span class="p">,</span> <span class="n">factors</span><span class="o">=</span><span class="n">factor_list</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                        <span class="n">end_date</span><span class="o">=</span><span class="n">last_date</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 如果是定义因子像ep()这种，需要因子计算</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">factor_data</span> <span class="o">=</span> <span class="n">calc_factors</span><span class="p">(</span><span class="n">securities</span><span class="o">=</span><span class="n">stock_list</span><span class="p">,</span> <span class="n">factors</span><span class="o">=</span><span class="n">factor_list</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="n">last_date</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                   <span class="n">end_date</span><span class="o">=</span><span class="n">last_date</span><span class="p">,</span> <span class="n">use_real_price</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">skip_paused</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">factor_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">factor</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">factor</span> <span class="ow">in</span> <span class="n">factor_list</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">factor_data</span><span class="p">[</span><span class="n">f</span><span class="p">])</span><span class="o">.</span><span class="n">T</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">factor_list</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">factor_list</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">df</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 例子</span>
</span></span><span class="line"><span class="cl"><span class="n">stock_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">normalize_code</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;301136&#34;</span><span class="p">,</span> <span class="s2">&#34;000586&#34;</span><span class="p">,</span> <span class="s2">&#34;300125&#34;</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl"><span class="n">factor_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;beta&#34;</span><span class="p">,</span> <span class="s2">&#34;size&#34;</span><span class="p">,</span> <span class="s2">&#34;momentum&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">get_factor_df</span><span class="p">(</span><span class="n">stock_list</span><span class="p">,</span> <span class="n">factor_list</span><span class="p">,</span> <span class="s2">&#34;20240701&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>输出</p>
<table>
<thead>
<tr>
<th style="text-align:center">code</th>
<th style="text-align:center">beta</th>
<th style="text-align:center">size</th>
<th style="text-align:center">momentum</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">301136.XSHE</td>
<td style="text-align:center">2.435321</td>
<td style="text-align:center">-2.257106</td>
<td style="text-align:center">-1.057598</td>
</tr>
<tr>
<td style="text-align:center">000586.XSHE</td>
<td style="text-align:center">2.069847</td>
<td style="text-align:center">-2.969061</td>
<td style="text-align:center">-1.214831</td>
</tr>
<tr>
<td style="text-align:center">300125.XSHE</td>
<td style="text-align:center">2.515297</td>
<td style="text-align:center">-4.036516</td>
<td style="text-align:center">-3.761750</td>
</tr>
</tbody>
</table>
<h2 id="获取每期股票对应的因子值和收益率">获取每期股票对应的因子值和收益率<a hidden class="anchor" aria-hidden="true" href="#获取每期股票对应的因子值和收益率">#</a></h2>
<p>输入日期，因子，以及股票池；对每天的因子值进行去极值（winsorize）、行业市值中性化（neutralize）、标准化（standardlize），至此因子预处理完成。</p>
<p>接着考虑下期收益率。不存在滞后算子时（lag=0）</p>
<p>$$
R_t=\frac{P_{t+1}}{P_t}
$$</p>
<p>若引入滞后算子$i\neq 0$，则</p>
<p>$$
R_t^i=\frac{P_{t+1+i}}{P_t}
$$</p>
<p>所以如果时间序列为 $t_1,t_2,t_3,t_4,t_5$，则lag=0时收益率数据只有四个$R_1,R_2,R_3,R_4$，lag=1时只有三个$R_1^1,R_2^1,R_3^1$，以此类推。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">date_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">lag_i</span>
</span></span></code></pre></div><p>左式为结束日期到当前日期的距离，右式为收益率跨度</p>
<p>验证：当lag_i = 0时，到最后一个时间点，即 <code>i=(len(date_list)-1)-1</code>，此时0&lt;0=False，存在即期收益率，正确。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 1.4-获取每期股票对应的因子值和收益率</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_fac_ret_dict</span><span class="p">(</span><span class="n">date_list</span><span class="p">,</span> <span class="n">factor_list</span><span class="p">,</span> <span class="n">index_code</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lag_num</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    params:
</span></span></span><span class="line"><span class="cl"><span class="s2">    date_list (list)：交易日列表
</span></span></span><span class="line"><span class="cl"><span class="s2">    factor_list (list)：因子名称列表，如 [&#34;residual_volatility&#34;, ...]
</span></span></span><span class="line"><span class="cl"><span class="s2">    index_code (str)：指数代码，表示股票池，None 表示全市场池
</span></span></span><span class="line"><span class="cl"><span class="s2">    lag_num (int)：收益率延期期数，方便后续计算因子 IC 半衰期
</span></span></span><span class="line"><span class="cl"><span class="s2">    
</span></span></span><span class="line"><span class="cl"><span class="s2">    return:
</span></span></span><span class="line"><span class="cl"><span class="s2">    dict：因子数据集的时间字典，格式为 {date: pd.DataFrame(index=[stock_list], columns=[factor_list + yield])}
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="n">lag_num_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">lag_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 删掉最后一期（需要下期收益率）</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">date_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">day</span> <span class="o">=</span> <span class="n">date_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 选择股票池</span>
</span></span><span class="line"><span class="cl">        <span class="n">pool</span> <span class="o">=</span> <span class="n">get_index_stocks</span><span class="p">(</span><span class="n">index_code</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span> <span class="k">if</span> <span class="n">index_code</span> <span class="k">else</span> <span class="n">get_all_securities</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">index</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 过滤股票</span>
</span></span><span class="line"><span class="cl">        <span class="n">pool</span> <span class="o">=</span> <span class="n">filter_stock</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 获取因子数据</span>
</span></span><span class="line"><span class="cl">        <span class="n">df</span> <span class="o">=</span> <span class="n">get_factor_df</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">factor_list</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;any&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">pool</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 异常值处理：中位数法</span>
</span></span><span class="line"><span class="cl">        <span class="n">df</span> <span class="o">=</span> <span class="n">winsorize_med</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">inclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inf2nan</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 行业市值中性化</span>
</span></span><span class="line"><span class="cl">        <span class="n">df</span> <span class="o">=</span> <span class="n">neutralize</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sw_l1&#39;</span><span class="p">,</span> <span class="s1">&#39;market_cap&#39;</span><span class="p">],</span> <span class="n">date</span><span class="o">=</span><span class="n">day</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 标准化</span>
</span></span><span class="line"><span class="cl">        <span class="n">df</span> <span class="o">=</span> <span class="n">standardlize</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">inf2nan</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 获取当天价格</span>
</span></span><span class="line"><span class="cl">        <span class="n">price</span> <span class="o">=</span> <span class="n">get_price</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">day</span><span class="p">,</span> <span class="n">skip_paused</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">panel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 计算延期收益率（每个lag单独算）</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">lag_i</span> <span class="ow">in</span> <span class="n">lag_num_list</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 剩余天数不足lag，用0填充</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">date_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">lag_i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">df</span><span class="p">[</span><span class="n">lag_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pool</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">next_day</span> <span class="o">=</span> <span class="n">date_list</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">lag_i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="n">next_price</span> <span class="o">=</span> <span class="n">get_price</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">next_day</span><span class="p">,</span> <span class="n">skip_paused</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                       <span class="n">panel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="n">df</span><span class="p">[</span><span class="n">lag_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_price</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="n">price</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">data_dict</span><span class="p">[</span><span class="n">day</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">data_dict</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 例子</span>
</span></span><span class="line"><span class="cl"><span class="n">date_list</span> <span class="o">=</span> <span class="n">get_calendar</span><span class="p">(</span><span class="n">end</span><span class="o">=</span><span class="s2">&#34;20240807&#34;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;W&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">factor_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;beta&#34;</span><span class="p">,</span> <span class="s2">&#34;size&#34;</span><span class="p">,</span> <span class="s2">&#34;momentum&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">index_code</span> <span class="o">=</span> <span class="s1">&#39;000300.XSHG&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">fac_ret_dict</span> <span class="o">=</span> <span class="n">get_fac_ret_dict</span><span class="p">(</span><span class="n">date_list</span><span class="p">,</span> <span class="n">factor_list</span><span class="p">,</span> <span class="n">index_code</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">date</span> <span class="o">=</span> <span class="n">date_list</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="s2"> 因子值和收益率&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fac_ret_dict</span><span class="p">[</span><span class="n">date</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</span></span></code></pre></div><p>输出</p>
<p>2024-06-21 00:00:00 因子值和收益率</p>
<table>
<thead>
<tr>
<th>code</th>
<th>beta</th>
<th>size</th>
<th>momentum</th>
<th>0</th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
<th>5</th>
</tr>
</thead>
<tbody>
<tr>
<td>000001.XSHE</td>
<td>0.716460</td>
<td>0.569768</td>
<td>-0.579750</td>
<td>0.015000</td>
<td>-0.003000</td>
<td>0.031000</td>
<td>0.037000</td>
<td>0.003000</td>
<td>0.014000</td>
</tr>
<tr>
<td>000002.XSHE</td>
<td>0.640406</td>
<td>0.438910</td>
<td>-0.987371</td>
<td>-0.036161</td>
<td>-0.043115</td>
<td>-0.033380</td>
<td>-0.018081</td>
<td>-0.048679</td>
<td>-0.052851</td>
</tr>
<tr>
<td>000063.XSHE</td>
<td>1.509532</td>
<td>1.183595</td>
<td>-0.655145</td>
<td>0.000366</td>
<td>-0.016850</td>
<td>0.023443</td>
<td>0.029670</td>
<td>-0.013553</td>
<td>-0.025275</td>
</tr>
<tr>
<td>000100.XSHE</td>
<td>-0.755233</td>
<td>0.651778</td>
<td>0.740881</td>
<td>0.018868</td>
<td>-0.004717</td>
<td>0.009434</td>
<td>-0.061321</td>
<td>-0.087264</td>
<td>-0.091981</td>
</tr>
<tr>
<td>000157.XSHE</td>
<td>-0.559411</td>
<td>-0.672491</td>
<td>0.715088</td>
<td>-0.026596</td>
<td>-0.063830</td>
<td>-0.057181</td>
<td>-0.074468</td>
<td>-0.102394</td>
<td>-0.125000</td>
</tr>
</tbody>
</table>
<h1 id="因子有效性测试">因子有效性测试<a hidden class="anchor" aria-hidden="true" href="#因子有效性测试">#</a></h1>
<h2 id="ic测试">IC测试<a hidden class="anchor" aria-hidden="true" href="#ic测试">#</a></h2>
<p>IC衡量预测变量的预测能力，其定义通常为$t+1$时刻的预测收益率与真实收益率在截面上的相关系数。</p>
<p>实操中，$t+1$时刻的预测收益率常用$t$时刻的预测变量代替（也就是因子值）</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 2.1 因子IC测试</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">factor_IC_test</span><span class="p">(</span><span class="n">_fac_ret_dict</span><span class="p">,</span> <span class="n">_factor_list</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">date_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_fac_ret_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">IC_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">date_list</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">_factor_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">IC_stats_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;IC_mean&#34;</span><span class="p">,</span> <span class="s2">&#34;IC_std&#34;</span><span class="p">,</span> <span class="s2">&#34;IR&#34;</span><span class="p">,</span> <span class="s2">&#34;sig_prop&#34;</span><span class="p">,</span> <span class="s2">&#34;t-value&#34;</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">_factor_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">date_list</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">factor</span> <span class="ow">in</span> <span class="n">_factor_list</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">fac_ret_df</span> <span class="o">=</span> <span class="n">_fac_ret_dict</span><span class="p">[</span><span class="n">date</span><span class="p">][[</span><span class="n">factor</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">            <span class="n">ic</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">spearmanr</span><span class="p">(</span><span class="n">fac_ret_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">factor</span><span class="p">],</span> <span class="n">fac_ret_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="n">IC_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">date</span><span class="p">,</span> <span class="n">factor</span><span class="p">]</span> <span class="o">=</span> <span class="n">ic</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">IC_stats_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&#34;IC_mean&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">IC_df</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">IC_stats_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&#34;IC_std&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">IC_df</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">IC_stats_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&#34;IR&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">IC_df</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">IC_df</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">IC_stats_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&#34;sig_prop&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">IC_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.02</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">IC_df</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">IC_stats_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&#34;t-value&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">IC_df</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">IC_df</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">IC_df</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">IC_df</span><span class="p">,</span> <span class="n">IC_stats_df</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 例子</span>
</span></span><span class="line"><span class="cl"><span class="n">IC_df</span><span class="p">,</span> <span class="n">IC_stats_df</span> <span class="o">=</span> <span class="n">factor_IC_test</span><span class="p">(</span><span class="n">fac_ret_dict</span><span class="p">,</span> <span class="n">factor_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">IC_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</span></span></code></pre></div><p>输出</p>
<table>
<thead>
<tr>
<th>Date</th>
<th>beta</th>
<th>size</th>
<th>momentum</th>
</tr>
</thead>
<tbody>
<tr>
<td>2024-05-17</td>
<td>-0.208500</td>
<td>0.056870</td>
<td>0.114491</td>
</tr>
<tr>
<td>2024-05-24</td>
<td>-0.106488</td>
<td>-0.011449</td>
<td>-0.013559</td>
</tr>
<tr>
<td>2024-05-31</td>
<td>-0.274823</td>
<td>0.185290</td>
<td>0.313269</td>
</tr>
<tr>
<td>2024-06-07</td>
<td>0.136722</td>
<td>-0.059606</td>
<td>-0.052470</td>
</tr>
<tr>
<td>2024-06-14</td>
<td>-0.184472</td>
<td>0.152148</td>
<td>0.299300</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">IC_stats_df</span>
</span></span></code></pre></div><p>输出</p>
<table>
<thead>
<tr>
<th></th>
<th>beta</th>
<th>size</th>
<th>momentum</th>
</tr>
</thead>
<tbody>
<tr>
<td>IC_mean</td>
<td>-0.058974</td>
<td>0.022510</td>
<td>0.025554</td>
</tr>
<tr>
<td>IC_std</td>
<td>0.141956</td>
<td>0.095083</td>
<td>0.184682</td>
</tr>
<tr>
<td>IR</td>
<td>-0.415435</td>
<td>0.236741</td>
<td>0.138367</td>
</tr>
<tr>
<td>sig_prop</td>
<td>1.000000</td>
<td>0.833333</td>
<td>0.916667</td>
</tr>
<tr>
<td>t-value</td>
<td>-1.439109</td>
<td>0.820095</td>
<td>0.479318</td>
</tr>
</tbody>
</table>
<h2 id="因子分组并计算组合收益率">因子分组并计算组合收益率<a hidden class="anchor" aria-hidden="true" href="#因子分组并计算组合收益率">#</a></h2>
<p>需要IC测试判断因子和收益率相关性的正负，再分组并构建投资组合</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 2.2-因子分组并计算投资组合收益率</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_group_portfolio_dict</span><span class="p">(</span><span class="n">_data_dict</span><span class="p">,</span> <span class="n">_factor_list</span><span class="p">,</span> <span class="n">neg_corr_fac_list</span><span class="p">,</span> <span class="n">group_num</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">weight_method</span><span class="o">=</span><span class="s2">&#34;avg&#34;</span><span class="p">,</span> <span class="n">index_code</span><span class="o">=</span><span class="s2">&#34;000300.XSHG&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    params:
</span></span></span><span class="line"><span class="cl"><span class="s2">    _data_dict(dict)：因子值数据集的时间字典，{date：pd.DataFrame(index=[stock_list], 
</span></span></span><span class="line"><span class="cl"><span class="s2">                                            columns=[_factor_list + yield(0)])}
</span></span></span><span class="line"><span class="cl"><span class="s2">    _factor_list(list)：因子名称列表，[&#34;residual_volatility&#34;,...]
</span></span></span><span class="line"><span class="cl"><span class="s2">    neg_corr_fac_list(list)：与收益率为负相关的因子名称列表
</span></span></span><span class="line"><span class="cl"><span class="s2">    group_num(int)：因子分组的组数，其中第0组为不分组
</span></span></span><span class="line"><span class="cl"><span class="s2">    weight_method(str)：投资组合股票权重类型
</span></span></span><span class="line"><span class="cl"><span class="s2">    index_code(str): 基准指数
</span></span></span><span class="line"><span class="cl"><span class="s2">    
</span></span></span><span class="line"><span class="cl"><span class="s2">    return:
</span></span></span><span class="line"><span class="cl"><span class="s2">    group_factor_dict(dict): 分组因子值数据集的时间字典，{date：pd.DataFrame(columns=[group_num])}
</span></span></span><span class="line"><span class="cl"><span class="s2">    group_yield_dict(dict): 分组股票收益率数据集的时间字典，{date：pd.DataFrame(columns=[group_num])}
</span></span></span><span class="line"><span class="cl"><span class="s2">    portfolio_yield_dict(dict): 分组投资组合收益率的时间字典，
</span></span></span><span class="line"><span class="cl"><span class="s2">    {date：pd.DataFrame(index=[date], columns=[0 + group_num + index + long_short])}
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">date_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_data_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 初始化字典：分组后的因子暴露和股票收益率</span>
</span></span><span class="line"><span class="cl">    <span class="n">group_factor_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">_factor_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">group_yield_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">_factor_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">factor</span> <span class="ow">in</span> <span class="n">_factor_list</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 每个value是新的字典 {date: None}</span>
</span></span><span class="line"><span class="cl">        <span class="n">group_factor_dict</span><span class="p">[</span><span class="n">factor</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">date_list</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">group_yield_dict</span><span class="p">[</span><span class="n">factor</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">date_list</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 初始化字典：投资组合的收益率</span>
</span></span><span class="line"><span class="cl">    <span class="n">group_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">group_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="c1"># 0代表不分组</span>
</span></span><span class="line"><span class="cl">    <span class="n">portfolio_yield_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">factor</span> <span class="ow">in</span> <span class="n">_factor_list</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">portfolio_yield_dict</span><span class="p">[</span><span class="n">factor</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">date_list</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">group_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 遍历每个时间点的因子值&amp;资产收益率</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">date</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">_data_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 遍历每个因子</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">factor</span> <span class="ow">in</span> <span class="n">_factor_list</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 如果因子与收益负相关</span>
</span></span><span class="line"><span class="cl">            <span class="n">is_ascending</span> <span class="o">=</span> <span class="n">factor</span> <span class="ow">in</span> <span class="n">neg_corr_fac_list</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># 若IC&lt;0, 则升序排列；若IC&gt;0, 则降序排列（收益率理应更高的股票排在前面）</span>
</span></span><span class="line"><span class="cl">            <span class="n">all_stock</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">factor</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="n">is_ascending</span><span class="p">)</span><span class="o">.</span><span class="n">index</span>
</span></span><span class="line"><span class="cl">            <span class="n">lens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_stock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># 无法被组数整除的部分用nan填充</span>
</span></span><span class="line"><span class="cl">            <span class="n">nan_num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">group_num</span> <span class="o">-</span> <span class="n">lens</span> <span class="o">%</span> <span class="n">group_num</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 股票分组，不足的补全nan值（用reshape分组）</span>
</span></span><span class="line"><span class="cl">            <span class="n">all_stock_filled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_stock</span><span class="p">,</span> <span class="n">nan_num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">group_stock</span> <span class="o">=</span> <span class="n">all_stock_filled</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">group_num</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># 股票收益率分组</span>
</span></span><span class="line"><span class="cl">            <span class="n">yield_</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">all_stock</span><span class="p">),</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span></span><span class="line"><span class="cl">            <span class="n">yield_filled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yield_</span><span class="p">,</span> <span class="n">nan_num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">group_yield</span> <span class="o">=</span> <span class="n">yield_filled</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">group_num</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># 股票因子值分组</span>
</span></span><span class="line"><span class="cl">            <span class="n">factor_</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">all_stock</span><span class="p">),</span> <span class="n">factor</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span></span><span class="line"><span class="cl">            <span class="n">factor_filled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">factor_</span><span class="p">,</span> <span class="n">nan_num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">group_factor</span> <span class="o">=</span> <span class="n">factor_filled</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">group_num</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># 分组后股票对应因子和对应收益率</span>
</span></span><span class="line"><span class="cl">            <span class="n">group_factor_dict</span><span class="p">[</span><span class="n">factor</span><span class="p">][</span><span class="n">date</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">group_factor</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">group_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</span></span><span class="line"><span class="cl">            <span class="n">group_yield_dict</span><span class="p">[</span><span class="n">factor</span><span class="p">][</span><span class="n">date</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">group_yield</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">group_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">weight_method</span> <span class="o">==</span> <span class="s2">&#34;mktcap&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 分组后市值加权投资组合收益率</span>
</span></span><span class="line"><span class="cl">                <span class="n">size_</span> <span class="o">=</span> <span class="n">get_factor_values</span><span class="p">(</span><span class="n">securities</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">all_stock</span><span class="p">),</span> <span class="n">factors</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;market_cap&#34;</span><span class="p">],</span> <span class="n">end_date</span><span class="o">=</span><span class="n">date</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                          <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="s2">&#34;market_cap&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="n">size0</span> <span class="o">=</span> <span class="n">size0</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">**</span> <span class="o">-</span><span class="mf">0.333</span><span class="p">)</span><span class="o">.</span><span class="n">values</span> <span class="c1"># 照顾小市值</span>
</span></span><span class="line"><span class="cl">                <span class="n">size_filled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">size_</span><span class="p">,</span> <span class="n">nan_num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">size_grouped</span> <span class="o">=</span> <span class="n">size_filled</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">group_num</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span> <span class="c1"># 将市值分组，得到每组市值</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 不分组，整体的收益</span>
</span></span><span class="line"><span class="cl">                <span class="n">portfolio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">yield_</span> <span class="o">*</span> <span class="p">(</span><span class="n">size_</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">size_</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 分组，每组的收益（组内的股票共用一个权重）</span>
</span></span><span class="line"><span class="cl">                <span class="n">portfolio_group</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">group_yield</span> <span class="o">*</span> <span class="p">(</span><span class="n">size_grouped</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">size_grouped</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># columns=[0, 1, 2, ..., n], with n groups</span>
</span></span><span class="line"><span class="cl">                <span class="n">portfolio_yield_dict</span><span class="p">[</span><span class="n">factor</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">date</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">portfolio</span><span class="p">,</span> <span class="n">portfolio_group</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 分组后等权投资组合收益率</span>
</span></span><span class="line"><span class="cl">                <span class="n">portfolio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">yield_</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">portfolio_group</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">group_yield</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">portfolio_yield_dict</span><span class="p">[</span><span class="n">factor</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">date</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">portfolio</span><span class="p">,</span> <span class="n">portfolio_group</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">    <span class="c1"># 将未分组、指数、多空组合统计进入投资组合中</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># date_list(_data_dict的键)删减了最后一个交易日，计算收益率需要补回来</span>
</span></span><span class="line"><span class="cl">    <span class="n">end_date</span> <span class="o">=</span> <span class="n">get_near_trade_day</span><span class="p">(</span><span class="n">date_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">index_price</span> <span class="o">=</span> <span class="n">get_price</span><span class="p">(</span><span class="n">index_code</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="n">date_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">end_date</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span> <span class="n">skip_paused</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                            <span class="n">panel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">date_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">end_date</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">index_price</span> <span class="o">=</span> <span class="n">index_price</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">date_list</span><span class="p">,</span> <span class="s2">&#34;open&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">factor</span> <span class="ow">in</span> <span class="n">_factor_list</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">portfolio_yield_dict</span><span class="p">[</span><span class="n">factor</span><span class="p">][</span><span class="s2">&#34;index&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">index_price</span> <span class="o">/</span> <span class="n">index_price</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;any&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 第一组 - 最后一组</span>
</span></span><span class="line"><span class="cl">        <span class="n">portfolio_yield_dict</span><span class="p">[</span><span class="n">factor</span><span class="p">][</span><span class="s2">&#34;long_short&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">portfolio_yield_dict</span><span class="p">[</span><span class="n">factor</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">portfolio_yield_dict</span><span class="p">[</span><span class="n">factor</span><span class="p">][</span><span class="n">group_num</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">group_factor_dict</span><span class="p">,</span> <span class="n">group_yield_dict</span><span class="p">,</span> <span class="n">portfolio_yield_dict</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 例子</span>
</span></span><span class="line"><span class="cl"><span class="n">data_dict</span> <span class="o">=</span> <span class="n">fac_ret_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">factor_list</span> <span class="o">=</span> <span class="n">factor_list</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">neg_corr_fac_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;beta&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">group_factor_dict</span><span class="p">,</span> <span class="n">group_yield_dict</span><span class="p">,</span> <span class="n">portfolio_yield_dict</span> <span class="o">=</span> <span class="n">get_group_portfolio_dict</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">factor_list</span><span class="p">,</span> <span class="n">neg_corr_fac_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;group_factor_dict: beta, </span><span class="si">{</span><span class="n">date_list</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">group_factor_dict</span><span class="p">[</span><span class="s2">&#34;beta&#34;</span><span class="p">][</span><span class="n">date_list</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># row as stocks(not the same in each row!), column as groups</span>
</span></span></code></pre></div><p>输出</p>
<p>group_factor_dict: beta, 2024-06-21 00:00:00</p>
<table>
<thead>
<tr>
<th></th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
<th>5</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>-3.127815</td>
<td>-0.782981</td>
<td>-0.220503</td>
<td>0.241513</td>
<td>0.899368</td>
</tr>
<tr>
<td>1</td>
<td>-2.608957</td>
<td>-0.777437</td>
<td>-0.217409</td>
<td>0.263952</td>
<td>0.905673</td>
</tr>
<tr>
<td>2</td>
<td>-2.466028</td>
<td>-0.771171</td>
<td>-0.213984</td>
<td>0.270753</td>
<td>0.906024</td>
</tr>
<tr>
<td>3</td>
<td>-2.379335</td>
<td>-0.770582</td>
<td>-0.209276</td>
<td>0.295320</td>
<td>0.926811</td>
</tr>
<tr>
<td>4</td>
<td>-2.236061</td>
<td>-0.755233</td>
<td>-0.204300</td>
<td>0.318216</td>
<td>0.939260</td>
</tr>
<tr>
<td>5</td>
<td>-2.146409</td>
<td>-0.753317</td>
<td>-0.200050</td>
<td>0.318709</td>
<td>0.942325</td>
</tr>
<tr>
<td>6</td>
<td>-2.138083</td>
<td>-0.748938</td>
<td>-0.196521</td>
<td>0.328538</td>
<td>0.945144</td>
</tr>
<tr>
<td>7</td>
<td>-1.982549</td>
<td>-0.728641</td>
<td>-0.196068</td>
<td>0.352257</td>
<td>0.968289</td>
</tr>
<tr>
<td>8</td>
<td>-1.951236</td>
<td>-0.672973</td>
<td>-0.195188</td>
<td>0.358029</td>
<td>0.974325</td>
</tr>
<tr>
<td>9</td>
<td>-1.912529</td>
<td>-0.669878</td>
<td>-0.190616</td>
<td>0.370640</td>
<td>0.985332</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;group_yield_dict: beta, </span><span class="si">{</span><span class="n">date_list</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">group_yield_dict</span><span class="p">[</span><span class="s2">&#34;beta&#34;</span><span class="p">][</span><span class="n">date_list</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span></span></code></pre></div><p>输出</p>
<p>group_yield_dict: beta, 2024-06-21 00:00:00</p>
<table>
<thead>
<tr>
<th></th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
<th>5</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0.015873</td>
<td>-0.054359</td>
<td>0.015328</td>
<td>0.005828</td>
<td>-0.004678</td>
</tr>
<tr>
<td>1</td>
<td>-0.029513</td>
<td>0.015817</td>
<td>-0.017335</td>
<td>0.054304</td>
<td>-0.030735</td>
</tr>
<tr>
<td>2</td>
<td>-0.038543</td>
<td>-0.097788</td>
<td>0.025758</td>
<td>0.003311</td>
<td>-0.072949</td>
</tr>
<tr>
<td>3</td>
<td>-0.059705</td>
<td>-0.009297</td>
<td>-0.072324</td>
<td>0.011792</td>
<td>-0.039123</td>
</tr>
<tr>
<td>4</td>
<td>0.056701</td>
<td>0.018868</td>
<td>-0.053505</td>
<td>-0.033629</td>
<td>-0.011364</td>
</tr>
<tr>
<td>5</td>
<td>-0.004926</td>
<td>-0.024651</td>
<td>-0.072303</td>
<td>0.013011</td>
<td>-0.063488</td>
</tr>
<tr>
<td>6</td>
<td>0.060438</td>
<td>0.042201</td>
<td>0.040793</td>
<td>0.053456</td>
<td>0.007519</td>
</tr>
<tr>
<td>7</td>
<td>-0.020833</td>
<td>-0.081037</td>
<td>-0.095761</td>
<td>-0.035380</td>
<td>-0.101844</td>
</tr>
<tr>
<td>8</td>
<td>-0.010228</td>
<td>0.048269</td>
<td>-0.039514</td>
<td>-0.073384</td>
<td>-0.038304</td>
</tr>
<tr>
<td>9</td>
<td>-0.063094</td>
<td>0.000000</td>
<td>0.013255</td>
<td>-0.039593</td>
<td>-0.027425</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;portfolio_yield_dict: beta&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">portfolio_yield_dict</span><span class="p">[</span><span class="s2">&#34;beta&#34;</span><span class="p">]</span>
</span></span></code></pre></div><p>输出</p>
<table>
<thead>
<tr>
<th>Date</th>
<th>0</th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
<th>5</th>
<th>index</th>
<th>long_short</th>
</tr>
</thead>
<tbody>
<tr>
<td>2024-05-17</td>
<td>-0.0212019</td>
<td>-0.0212385</td>
<td>-0.0172659</td>
<td>-0.0110899</td>
<td>-0.024375</td>
<td>-0.0330077</td>
<td>-0.002124</td>
<td>0.0117692</td>
</tr>
<tr>
<td>2024-05-24</td>
<td>-0.0026993</td>
<td>-0.00157968</td>
<td>5.88723e-05</td>
<td>0.00493396</td>
<td>-0.014688</td>
<td>-0.00217902</td>
<td>-0.008541</td>
<td>0.00059934</td>
</tr>
<tr>
<td>2024-05-31</td>
<td>-0.00422427</td>
<td>0.0113847</td>
<td>-0.00175829</td>
<td>0.000561831</td>
<td>-0.0162851</td>
<td>-0.0159888</td>
<td>-0.001442</td>
<td>0.0273735</td>
</tr>
<tr>
<td>2024-06-07</td>
<td>-0.00109651</td>
<td>-0.00648105</td>
<td>-0.00998194</td>
<td>6.14662e-05</td>
<td>7.22157e-05</td>
<td>0.0119131</td>
<td>-0.022208</td>
<td>-0.0183942</td>
</tr>
<tr>
<td>2024-06-14</td>
<td>-0.0165621</td>
<td>-0.00675819</td>
<td>-0.016695</td>
<td>-0.0076833</td>
<td>-0.0241726</td>
<td>-0.0284781</td>
<td>-0.005252</td>
<td>0.0217199</td>
</tr>
<tr>
<td>2024-06-21</td>
<td>-0.0169605</td>
<td>-0.012736</td>
<td>-0.010357</td>
<td>-0.0100194</td>
<td>-0.0143996</td>
<td>-0.0391058</td>
<td>-0.015064</td>
<td>0.0263698</td>
</tr>
<tr>
<td>2024-06-28</td>
<td>-0.0133534</td>
<td>-0.0159938</td>
<td>-0.00656651</td>
<td>-0.00745181</td>
<td>-0.0158852</td>
<td>-0.0215409</td>
<td>-0.000090</td>
<td>0.00554702</td>
</tr>
<tr>
<td>2024-07-05</td>
<td>0.0163921</td>
<td>0.0105308</td>
<td>0.0197113</td>
<td>0.00671937</td>
<td>0.0250903</td>
<td>0.0202228</td>
<td>0.004821</td>
<td>-0.00969201</td>
</tr>
<tr>
<td>2024-07-12</td>
<td>0.0231685</td>
<td>0.0313948</td>
<td>0.0179932</td>
<td>0.015852</td>
<td>0.0219193</td>
<td>0.0291754</td>
<td>0.011806</td>
<td>0.00221932</td>
</tr>
<tr>
<td>2024-07-19</td>
<td>-0.0316384</td>
<td>-0.0362365</td>
<td>-0.0269216</td>
<td>-0.0324149</td>
<td>-0.0317956</td>
<td>-0.0307507</td>
<td>-0.027736</td>
<td>-0.00548579</td>
</tr>
<tr>
<td>2024-07-26</td>
<td>-0.000504842</td>
<td>-0.00238374</td>
<td>-0.0017709</td>
<td>-0.00674665</td>
<td>-0.00465131</td>
<td>0.0142367</td>
<td>-0.002876</td>
<td>-0.0166205</td>
</tr>
<tr>
<td>2024-08-02</td>
<td>-0.00884012</td>
<td>-0.00919352</td>
<td>-0.0124423</td>
<td>-0.00690704</td>
<td>-0.00256224</td>
<td>-0.0134754</td>
<td>-0.009373</td>
<td>0.0042819</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">plot_return</span><span class="p">(</span><span class="n">portfolio_yield_dict</span><span class="p">[</span><span class="s2">&#34;beta&#34;</span><span class="p">])</span>
</span></span></code></pre></div><p><img loading="lazy" src="long_short.png" alt="long_short"  />
</p>
<h1 id="工具函数">工具函数<a hidden class="anchor" aria-hidden="true" href="#工具函数">#</a></h1>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_near_trade_day</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    获取相邻的交易日。
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    参数:
</span></span></span><span class="line"><span class="cl"><span class="s2">    date (Timestamp)：当天交易日，年月日。
</span></span></span><span class="line"><span class="cl"><span class="s2">    count (int)：交易日相隔数，负数代表前，正数代表后。
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    返回:
</span></span></span><span class="line"><span class="cl"><span class="s2">    Timestamp：上一个或下一个交易日，年月日。
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 获取上一个交易日</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">df</span> <span class="o">=</span> <span class="n">get_price</span><span class="p">(</span><span class="s1">&#39;000001.XSHG&#39;</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">date</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 获取下一个交易日</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">df</span> <span class="o">=</span> <span class="n">get_price</span><span class="p">(</span><span class="s1">&#39;000001.XSHG&#39;</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="n">date</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">count</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 如果 count == 0，返回原日期</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">date</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">plot_return</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    绘制收益率曲线图
</span></span></span><span class="line"><span class="cl"><span class="s2">    
</span></span></span><span class="line"><span class="cl"><span class="s2">    params:
</span></span></span><span class="line"><span class="cl"><span class="s2">    df(dataframe): 每日收益率数据，pd.DataFrame(index=[dates], columns=[portfolios])
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">num_ticks</span> <span class="o">=</span> <span class="mi">12</span>
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">cum_return</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span> 
</span></span><span class="line"><span class="cl">        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">cum_return</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">col</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&#34;ms&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_ticks</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">dates</span><span class="p">[</span><span class="n">ticks</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">DateFormatter</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">autofmt_xdate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 计时器</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">count_time</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">number</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
</span></span></code></pre></div><h1 id="不足之处">不足之处<a hidden class="anchor" aria-hidden="true" href="#不足之处">#</a></h1>
<ol>
<li>借用了JoinQuant平台的内置函数，只能在平台上运行，对内存、算力等有限制，自由度太低</li>
<li>目前只实现了基本的因子测试部分（IC，long-short），更多功能有
<ul>
<li>测试部分加上FSC，t统计量指标</li>
<li>缺少Fama-MacBeth等回归（结合石川因子投资）</li>
<li>缺少组合优化和选股</li>
</ul>
</li>
<li>Python运行速度很慢</li>
</ol>
<p>下阶段将重点研究</p>
<ul>
<li>更多因子投资方法</li>
<li>将以上框架用DolphinDB实现</li>
<li>将新的因子投资方法用DolphinDB实现</li>
</ul>
<p>预计10月前完成。因子框架完成后在筹码分布上测试，连接到筹码这部分只需把计算筹码数据和筹码因子的函数换成DolphinDB语言，工作量不大，同期可以记录些筹码因子的idea</p>
<h1 id="参考文献">参考文献<a hidden class="anchor" aria-hidden="true" href="#参考文献">#</a></h1>
<ul>
<li><a href="https://www.joinquant.com/community/post/detailMobile?postId=43978">因子研究框架—收益模型篇</a></li>
<li><a href="https://www.joinquant.com/view/community/detail/92d3af8a25c56640479abe2d5b6f7d81">自定义python库</a></li>
<li>《因子投资 - 方法与实践》</li>
<li><a href="https://www.joinquant.com/help/api/help#name:api">API文档</a></li>
<li><a href="https://www.joinquant.com/help/api/help#name:factor_values">因子库</a></li>
<li><a href="https://www.joinquant.com/help/api/help#factor:%E5%9B%A0%E5%AD%90%E5%88%86%E6%9E%90API">因子分析（定义因子）</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/blog/tags/%E5%9B%A0%E5%AD%90/">因子</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="http://localhost:1313/blog/">Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
